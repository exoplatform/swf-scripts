name: PLF PR Task Webhook

on:
  workflow_call:
    inputs:
      TARGET_SERVER:
        description: Target Server (tribe or builders)
        default: 'tribe'
        required: false
        type: string
    secrets:
      SERVER_USERNAME:
        required: true
      SERVER_PASSWORD:
        required: true
      SERVER_TASK_REST_PREFIXE_URL:
        required: true
      SERVER_GAMGH_CONNECTOR_REST_URL:
        required: true
env:
  message: ${{ github.event.pull_request.title }}
  state: ${{ github.event.pull_request.state }}
  pull_number: ${{ github.event.pull_request.number }}
  requested_reviewer: ${{ github.event.requested_reviewer.login }}
  creator: ${{ github.event.pull_request.user.login }}
  repo_name: ${{ github.event.repository.full_name }}
  base_branch_name: ${{ github.event.pull_request.base.ref }}
jobs:
  check_tasks:
    name: Check for tasks identifiers
    runs-on: ubuntu-latest
    steps:
      - name: PLF Tasks Webhook
        run: |
          case ${{ inputs.TARGET_SERVER }} in
            tribe)
              regexFilter='(task|maint|exo)((-|_)[0-9]{4,})+'
              ;;

            builders)
              regexFilter='meed((-|_)[0-9]{4,})+'
              ;;

            *)
              echo "Error target Server ${{ inputs.TARGET_SERVER }} is not yet supported!"
              exit 1
            ;;
          esac 
          TASKS_IDS="$(echo ${message:-}| grep -ioP ${regexFilter} | grep -oP [0-9]+ | xargs)"
          if [ -z "${TASKS_IDS}" ]; then
            echo "No tasks found! Abort."
            exit 0
          fi
          echo "OK Task(s) found! Starting notifications..."
          link="PR <a href=\"https://github.com/${repo_name}/pull/${pull_number}\">${repo_name}#${pull_number}</a>"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.action }}" = "review_requested" ]; then
              serverUser=$(curl -s -f -L -u ${SERVER_USERNAME}:${SERVER_PASSWORD} -XGET "${SERVER_GAMGH_CONNECTOR_REST_URL}/users/${requested_reviewer}" || echo "")
              if [ ! -z "${serverUser}" ]; then
                echo "Requested reviewer is: ${serverUser}."
                msg="üí≠ $link requested a review from @${serverUser} "
              else
                echo "Could not get Server user identifier! Abort"
                exit 0
              fi
            elif [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              msg="üåü $link has been merged into ${base_branch_name}."
            else
              msg="‚ÑπÔ∏è $link has been ${{ github.event.action }}."
            fi
          elif [ "${{ github.event_name }}" = "pull_request_review" ] && [ "${{ github.event.action }}" = "submitted" ]; then
            mentionCreator=""
            commentMentionFilterRegex='( |^)@[a-zA-Z0-9]+-?[a-zA-Z0-9]+( |$)'
            response=$(curl -s -f -L -u ${SERVER_USERNAME}:${SERVER_PASSWORD} -XGET "${SERVER_GAMGH_CONNECTOR_REST_URL}/users/${creator}" || echo "")
            [ -z "${response}" ] || mentionCreator=" FYI @${response} "
            if [ "${{ github.event.review.state }}" = "changes_requested" ]; then
              msg="üõ†Ô∏è $link requires some changes.${mentionCreator}"
            elif [ "${{ github.event.review.state }}" = "approved" ]; then
              msg="‚úÖ $link has been ${{ github.event.review.state }}.${mentionCreator}"
            elif [ "${{ github.event.review.state }}" = "commented" ] && [[ "${{ github.event.review.body }}" =~ $commentMentionFilterRegex ]]; then
              mentionedGithubUsers=$(${{ github.event.review.body }} | grep -oP $commentMentionFilterRegex | tr -d '@' | xargs)
              mentionedServerUsers=""
              for mentionedGithubUser in ${mentionedGithubUsers}; do 
                response=$(curl -s -f -L -u ${SERVER_USERNAME}:${SERVER_PASSWORD} -XGET "${SERVER_GAMGH_CONNECTOR_REST_URL}/users/${mentionedGithubUser}" || echo "")
                [ -z "${response}" ] && continue
                [ -z "${mentionedServerUsers}" ] && mentionedServerUsers="@${response}" || mentionedServerUsers="${mentionedServerUsers} and @${response}"
              done
              [ -z "${mentionedServerUsers}" ] && mentionedServerUsers="$(echo $mentionedGithubUsers | wc -w ) user(s)"
              msg="üôã $link has mentioned ${mentionedServerUsers} in a comment."
            else
              msg="‚ÑπÔ∏è $link has been ${{ github.event.review.state }}."
            fi
          fi
          echo "*** Message is:"
          echo ${msg}
          echo "***"
          for TASK_ID in ${TASKS_IDS}; do
            echo "Commenting to Task #${TASK_ID}..."
            curl -so /dev/null -w '%{http_code}' -L -u ${SERVER_USERNAME}:${SERVER_PASSWORD} -XPOST --data-urlencode "<p>${msg}</p>" "${SERVER_TASK_REST_PREFIXE_URL}/comments/${TASK_ID}"
          done
        env:
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          SERVER_TASK_REST_PREFIXE_URL: ${{ secrets.SERVER_TASK_REST_PREFIXE_URL }}
          SERVER_GAMGH_CONNECTOR_REST_URL: ${{ secrets.SERVER_GAMGH_CONNECTOR_REST_URL }}